# Continuous Integration Workflow for XDB-Node
#
# This workflow runs on every push to all branches and pull request to main to ensure code quality
# and compatibility across multiple Node.js LTS versions.
#
# The CI pipeline performs the following checks:
# 1. Code formatting verification using Prettier
# 2. Unit tests execution using Jest with coverage reporting
# 3. TypeScript compilation to ensure type safety
# 4. Compatibility testing across multiple Node.js versions (18.x, 20.x, 22.x)

name: CI

on:
  # Trigger workflow on push to all branches
  push:
    branches: ["**"]
  # Trigger workflow on pull requests targeting main branch only
  pull_request:
    branches: [main]

# Environment variables available to all jobs
env:
  NODE_OPTIONS: --max-old-space-size=4096

jobs:
  # Main job: Test and verify code quality
  test-and-verify:
    name: Test and Verify (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      # Fail fast: stop all matrix jobs if one fails
      fail-fast: false
      matrix:
        # Test across major Node.js LTS versions to ensure broad compatibility
        node-version: [18.x, 20.x, 22.x]

    steps:
      # Step 1: Checkout the repository source code
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Install pnpm package manager
      - name: Install pnpm package manager
        uses: pnpm/action-setup@v3
        with:
          version: 10
          run_install: false

      # Step 3: Setup Node.js environment with specified version
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm

      # Step 4: Install all project dependencies
      - name: Install project dependencies
        run: pnpm install --frozen-lockfile
        env:
          CI: true

      # Step 5: Verify code formatting with Prettier
      - name: Verify code formatting (Prettier)
        run: pnpm run format:check
        if: always()

      # Step 6: Execute unit tests with Jest
      - name: Execute unit tests (Jest)
        run: pnpm run test:coverage
        env:
          CI: true
        if: always()

      # Step 7: Upload coverage reports
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
        if: matrix.node-version == '20.x' && always()

      # Step 8: Verify production build (TypeScript compilation)
      - name: Verify production build (TypeScript)
        run: pnpm run build
        if: always()

      # Step 9: Security audit
      - name: Security audit (npm audit)
        run: pnpm audit --audit-level=moderate
        if: always()
        continue-on-error: true

  # Workflow status check
  workflow-status:
    name: Workflow Status
    runs-on: ubuntu-latest
    needs: [test-and-verify]
    if: always()

    steps:
      - name: Check workflow status
        run: |
          if [ "${{ needs.test-and-verify.result }}" == "failure" ]; then
            echo "CI workflow failed"
            exit 1
          else
            echo "CI workflow passed"
          fi
          